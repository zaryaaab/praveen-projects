<div class="admin-container">
  <div class="admin-header">
    <div>
      <h1 class="page-title">Admin Dashboard</h1>
      <p class="page-subtitle">Manage library resources, users, and reservations</p>
    </div>
    <div>
      <button mat-raised-button color="primary" (click)="openAddBookDialog()">
        <mat-icon>add</mat-icon>
        Add New Book
      </button>
    </div>
  </div>


  <mat-tab-group>
    <mat-tab label="Books">
      <div class="tab-content">
        <mat-card>
          <mat-card-header>
            <mat-card-title>Book Management</mat-card-title>
            <mat-card-subtitle>Add, edit, or remove books from the library</mat-card-subtitle>
            <div class="search-container">
              <mat-form-field appearance="outline">
                <mat-label>Search books</mat-label>
                <input matInput [(ngModel)]="searchTerm">
                <mat-icon matPrefix>search</mat-icon>
              </mat-form-field>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="table-container">
              <table mat-table [dataSource]="filteredBooks" class="mat-elevation-z0">
                <!-- Title Column -->
                <ng-container matColumnDef="title">
                  <th mat-header-cell *matHeaderCellDef>Title</th>
                  <td mat-cell *matCellDef="let book">{{book.title}}</td>
                </ng-container>

                <!-- Author Column -->
                <ng-container matColumnDef="author">
                  <th mat-header-cell *matHeaderCellDef>Author</th>
                  <td mat-cell *matCellDef="let book">{{book.author}}</td>
                </ng-container>

                <!-- ISBN Column -->
                <ng-container matColumnDef="isbn">
                  <th mat-header-cell *matHeaderCellDef>ISBN</th>
                  <td mat-cell *matCellDef="let book">{{book.isbn}}</td>
                </ng-container>

                <!-- Category Column -->
                <ng-container matColumnDef="category">
                  <th mat-header-cell *matHeaderCellDef>Category</th>
                  <td mat-cell *matCellDef="let book">{{book.category}}</td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>Status</th>
                  <td mat-cell *matCellDef="let book">
                    <span class="status-badge" [ngClass]="'status-' + book.status">
                      {{book.status | titlecase}}
                    </span>
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef class="actions-column">Actions</th>
                  <td mat-cell *matCellDef="let book" class="actions-column">
                    <button mat-icon-button color="primary" (click)="openEditBookDialog(book)" matTooltip="Edit book">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" (click)="deleteBook(book)" matTooltip="Delete book">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedBookColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedBookColumns;"></tr>
              </table>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

    <mat-tab label="Reservations">
      <div class="tab-content">
        <mat-card>
          <mat-card-header>
            <mat-card-title>Reservation Requests</mat-card-title>
            <mat-card-subtitle>Approve or deny book reservation requests</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="table-container">
              <table mat-table [dataSource]="reservations" class="mat-elevation-z0">
                <!-- Book Title Column -->
                <ng-container matColumnDef="bookTitle">
                  <th mat-header-cell *matHeaderCellDef>Book Title</th>
                  <td mat-cell *matCellDef="let reservation">{{reservation.book.title}}</td>
                </ng-container>

                <!-- Student Name Column -->
                <ng-container matColumnDef="studentName">
                  <th mat-header-cell *matHeaderCellDef>Student Name</th>
                  <td mat-cell *matCellDef="let reservation">{{reservation.user.firstName+ ' '+
                    reservation.user.lastName}}</td>
                </ng-container>

                <!-- Request Date Column -->
                <ng-container matColumnDef="requestDate">
                  <th mat-header-cell *matHeaderCellDef>Request Date</th>
                  <td mat-cell *matCellDef="let reservation">{{reservation.requestDate | date:'MMM d, y'}}</td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>Status</th>
                  <td mat-cell *matCellDef="let reservation">
                    <span class="status-badge" [ngClass]="'status-' + reservation.status">
                      {{reservation.status}}
                    </span>
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef class="actions-column">Actions</th>
                  <td mat-cell *matCellDef="let reservation" class="actions-column">
                    <button mat-stroked-button color="primary" class="action-button" *ngIf="!['approved','denied'].includes(reservation.status) && reservation.book?.status === 'available'"
                      (click)="approveReservation(reservation)">
                      <mat-icon>check_circle</mat-icon>
                      Approve
                    </button>
                    <button mat-stroked-button color="warn" class="action-button" *ngIf="!['approved','denied'].includes(reservation.status)"
                      (click)="denyReservation(reservation)">
                      <mat-icon>cancel</mat-icon>
                      Deny
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedReservationColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedReservationColumns;"></tr>
              </table>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>
  </mat-tab-group>

  <!-- Add Book Dialog -->
  <div *ngIf="addBookDialogOpen" class="dialog-backdrop">
    <mat-card class="dialog-card">
      <mat-card-header>
        <mat-card-title>Add New Book</mat-card-title>
        <mat-card-subtitle>Enter the details of the new book to add to the library.</mat-card-subtitle>
        <button mat-icon-button class="close-button" (click)="closeAddBookDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="addBookForm">
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Title</mat-label>
              <input matInput formControlName="title">
              <mat-error *ngIf="addBookForm.get('title')?.hasError('required')">
                Title is required
              </mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Author</mat-label>
              <input matInput formControlName="author">
              <mat-error *ngIf="addBookForm.get('author')?.hasError('required')">
                Author is required
              </mat-error>
            </mat-form-field>
          </div>
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>ISBN</mat-label>
              <input matInput formControlName="isbn">
              <mat-error *ngIf="addBookForm.get('isbn')?.hasError('required')">
                ISBN is required
              </mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Category</mat-label>
              <mat-select formControlName="category">
                <mat-option value="software">Software Engineering</mat-option>
                <mat-option value="architecture">Software Architecture</mat-option>
                <mat-option value="data">Data Science</mat-option>
                <mat-option value="ai">Artificial Intelligence</mat-option>
                <mat-option value="networks">Computer Networks</mat-option>
              </mat-select>
              <mat-error *ngIf="addBookForm.get('category')?.hasError('required')">
                Category is required
              </mat-error>
            </mat-form-field>
          </div>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description</mat-label>
            <textarea matInput formControlName="description" rows="4"></textarea>
          </mat-form-field>
          <div class="form-row">
            <div class="cover-image-upload">
              <label for="coverImage">Cover Image</label>
              <input type="file" id="coverImage" (change)="onCoverImageSelected($event)" accept="image/*"
                style="display: none">
              <div class="image-preview" (click)="triggerCoverImageUpload()">
                <img *ngIf="coverImagePreview" [src]="coverImagePreview" alt="Book cover preview">
                <mat-icon *ngIf="!coverImagePreview">add_photo_alternate</mat-icon>
                <span *ngIf="!coverImagePreview">Click to upload cover image</span>
              </div>
              <mat-error *ngIf="coverImageError">{{ coverImageError }}</mat-error>
            </div>
          </div>
        </form>
      </mat-card-content>
      <mat-card-actions align="end">
        <button mat-button (click)="closeAddBookDialog()">Cancel</button>
        <button mat-raised-button color="primary" (click)="addBook()">Add Book</button>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- Edit Book Dialog -->
  <div *ngIf="editBookDialogOpen" class="dialog-backdrop">
    <mat-card class="dialog-card">
      <mat-card-header>
        <mat-card-title>Edit Book</mat-card-title>
        <mat-card-subtitle>Update the details of the selected book.</mat-card-subtitle>
        <button mat-icon-button class="close-button" (click)="closeEditBookDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="editBookForm">
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Title</mat-label>
              <input matInput formControlName="title">
              <mat-error *ngIf="editBookForm.get('title')?.hasError('required')">
                Title is required
              </mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Author</mat-label>
              <input matInput formControlName="author">
              <mat-error *ngIf="editBookForm.get('author')?.hasError('required')">
                Author is required
              </mat-error>
            </mat-form-field>
          </div>
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>ISBN</mat-label>
              <input matInput formControlName="isbn">
              <mat-error *ngIf="editBookForm.get('isbn')?.hasError('required')">
                ISBN is required
              </mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Category</mat-label>
              <mat-select formControlName="category">
                <mat-option value="software">Software Engineering</mat-option>
                <mat-option value="architecture">Software Architecture</mat-option>
                <mat-option value="data">Data Science</mat-option>
                <mat-option value="ai">Artificial Intelligence</mat-option>
                <mat-option value="networks">Computer Networks</mat-option>
              </mat-select>
              <mat-error *ngIf="editBookForm.get('category')?.hasError('required')">
                Category is required
              </mat-error>
            </mat-form-field>
          </div>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Status</mat-label>
            <mat-select formControlName="status">
              <mat-option value="available">Available</mat-option>
              <mat-option value="borrowed">Borrowed</mat-option>
            </mat-select>
            <mat-error *ngIf="editBookForm.get('status')?.hasError('required')">
              Status is required
            </mat-error>
          </mat-form-field>
        </form>
      </mat-card-content>
      <mat-card-actions align="end">
        <button mat-button (click)="closeEditBookDialog()">Cancel</button>
        <button mat-raised-button color="primary" (click)="editBook()">Save Changes</button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>