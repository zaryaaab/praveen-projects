<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head}">
    <title>EduSync - View Assignment</title>
</head>
<body>
    <nav th:replace="~{layout :: nav}"></nav>
    
    <div class="main-content">
        <div class="container">
            <!-- Alert Messages -->
            <div th:if="${success}" class="alert alert-success" role="alert" th:text="${success}"></div>
            <div th:if="${error}" class="alert alert-danger" role="alert" th:text="${error}"></div>
            
            <!-- Page Content -->
            <h2 class="mb-4" th:text="${assignment.title}">Assignment Title</h2>
            
            <!-- Assignment Details -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Assignment Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">Course:</dt>
                                <dd class="col-sm-8" th:text="${assignment.course.courseName + ' (' + assignment.course.courseCode + ')'}">Course Name (CS101)</dd>
                                
                                <dt class="col-sm-4">Due Date:</dt>
                                <dd class="col-sm-8" th:text="${#temporals.format(assignment.dueDate, 'dd MMM yyyy')}">01-01-2023</dd>
                                
                                <dt class="col-sm-4">Total Marks:</dt>
                                <dd class="col-sm-8" th:text="${assignment.totalMarks}">100</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">Total Submissions:</dt>
                                <dd class="col-sm-8">
                                    <span th:if="${submissions != null}" th:text="${submissions.size()}">0</span>
                                    <span th:if="${submissions == null}">0</span>
                                </dd>
                                
                                <dt class="col-sm-4">Status:</dt>
                                <dd class="col-sm-8">
                                    <span class="badge bg-success" th:if="${assignment.dueDate.isAfter(#temporals.createToday())}">Open</span>
                                    <span class="badge bg-danger" th:unless="${assignment.dueDate.isAfter(#temporals.createToday())}">Closed</span>
                                </dd>
                            </dl>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6>Description:</h6>
                        <p th:text="${assignment.description}">Assignment description goes here...</p>
                    </div>
                </div>
            </div>
            
            <!-- Student Submissions -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Student Submissions</h5>
                </div>
                <div class="card-body">
                    <div th:if="${submissions == null || submissions.isEmpty()}" class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No submissions have been made for this assignment yet.
                    </div>
                    
                    <div th:if="${submissions != null && !submissions.isEmpty()}" class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Submission Date</th>
                                    <th>Attachment</th>
                                    <th>Status</th>
                                    <th>Marks</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="submission : ${submissions}">
                                    <td th:text="${submission.student.user.fullName + ' (' + submission.student.studentId + ')'}">Student Name (S12345)</td>
                                    <td th:text="${#temporals.format(submission.submissionDate, 'dd MMM yyyy HH:mm')}">01-01-2023 10:30</td>
                                    <td>
                                        <a th:if="${submission.fileName != null}" th:href="@{/student/submissions/{id}/download(id=${submission.id})}" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-download"></i> <span th:text="${submission.fileName}">file.pdf</span>
                                        </a>
                                        <span th:unless="${submission.fileName != null}" class="text-muted">No file</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success" th:if="${submission.graded}">Graded</span>
                                        <span class="badge bg-warning" th:unless="${submission.graded}">Pending</span>
                                    </td>
                                    <td>
                                        <span th:if="${submission.graded}" th:text="${submission.obtainedMarks + '/' + assignment.totalMarks}">85/100</span>
                                        <span th:unless="${submission.graded}">Not graded</span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-primary" 
                                                th:attr="data-bs-submission-id=${submission.id}, 
                                                         data-bs-student-name=${submission.student.user.fullName},
                                                         data-bs-submission-content=${submission.submissionContent},
                                                         data-bs-has-file=${submission.fileName != null},
                                                         data-bs-file-name=${submission.fileName},
                                                         data-bs-graded=${submission.graded},
                                                         data-bs-marks=${submission.obtainedMarks},
                                                         data-bs-feedback=${submission.feedback}"
                                                data-bs-toggle="modal" data-bs-target="#viewSubmissionModal">
                                            <i class="bi bi-eye"></i> View & Grade
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- View Submission Modal -->
            <div class="modal fade" id="viewSubmissionModal" tabindex="-1" aria-labelledby="viewSubmissionModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="viewSubmissionModalLabel">Student Submission</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <h6>Student: <span id="submissionStudentName">Student Name</span></h6>
                            
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Submission Content</h6>
                                </div>
                                <div class="card-body">
                                    <div id="submissionContent" class="border p-3 bg-light">
                                        Submission content will appear here...
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Attached File -->
                            <div id="attachmentSection" class="card mb-3 d-none">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Attachment</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="me-2">
                                            <i class="bi bi-file-earmark fs-4"></i>
                                        </div>
                                        <div>
                                            <div id="attachmentFileName" class="fw-bold">file.pdf</div>
                                        </div>
                                        <div class="ms-auto">
                                            <a id="attachmentDownloadLink" href="#" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-download"></i> Download
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <form id="gradeSubmissionForm" method="post">
                                <div class="mb-3">
                                    <label for="marks" class="form-label">Marks (out of <span th:text="${assignment.totalMarks}">100</span>)</label>
                                    <input type="number" class="form-control" id="marks" name="marks" min="0" th:max="${assignment.totalMarks}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="feedback" class="form-label">Feedback</label>
                                    <textarea class="form-control" id="feedback" name="feedback" rows="3"></textarea>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-success">Save Grade</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Back Button -->
            <div class="mt-4">
                <a th:href="@{/faculty/assignments}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Assignments
                </a>
            </div>
        </div>
    </div>
    
    <footer th:replace="~{layout :: footer}"></footer>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Submission Modal Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const viewSubmissionModal = document.getElementById('viewSubmissionModal');
            if (viewSubmissionModal) {
                viewSubmissionModal.addEventListener('show.bs.modal', function(event) {
                    const button = event.relatedTarget;
                    const submissionId = button.getAttribute('data-bs-submission-id');
                    const studentName = button.getAttribute('data-bs-student-name');
                    const submissionContent = button.getAttribute('data-bs-submission-content');
                    const hasFile = button.getAttribute('data-bs-has-file') === 'true';
                    const fileName = button.getAttribute('data-bs-file-name');
                    const graded = button.getAttribute('data-bs-graded') === 'true';
                    const marks = button.getAttribute('data-bs-marks');
                    const feedback = button.getAttribute('data-bs-feedback');
                    
                    // Update modal content
                    document.getElementById('submissionStudentName').textContent = studentName;
                    document.getElementById('submissionContent').textContent = submissionContent;
                    
                    // Handle file attachment
                    const attachmentSection = document.getElementById('attachmentSection');
                    if (hasFile) {
                        document.getElementById('attachmentFileName').textContent = fileName;
                        document.getElementById('attachmentDownloadLink').href = '/student/submissions/' + submissionId + '/download';
                        attachmentSection.classList.remove('d-none');
                    } else {
                        attachmentSection.classList.add('d-none');
                    }
                    
                    // Pre-fill grade form if already graded
                    if (graded) {
                        document.getElementById('marks').value = marks;
                        document.getElementById('feedback').value = feedback || '';
                    } else {
                        document.getElementById('marks').value = '';
                        document.getElementById('feedback').value = '';
                    }
                    
                    // Update form action
                    const gradeForm = document.getElementById('gradeSubmissionForm');
                    gradeForm.action = '/faculty/submissions/' + submissionId + '/grade';
                });
            }
        });
    </script>
</body>
</html> 